# Project File Summaries

| File | Summary |
| ---- | ------- |
| [`setup.cfg`](setup.cfg)| This configuration file, `setup.cfg`, defines metadata and options for the `poemai-utils` Python project. It specifies project details, dependencies, package discovery, testing configurations, and code style settings. It also includes options for additional requirements and entry points for console scripts. |
| [`src/poemai_utils/__init__.py`](src/poemai_utils/__init__.py)| This file checks the Python version and imports the appropriate modules for retrieving package metadata. It attempts to get the version of the 'poemai-utils' package, handling cases where the package might not be found. The version information is stored in the `__version__` variable, defaulting to 'unknown' if not found. |
| [`src/poemai_utils/ai_model.py`](src/poemai_utils/ai_model.py)| This file defines an enumeration for AI API types and a class for managing AI models. The `AIModel` class allows for dynamic registration and retrieval of models, supports equality checks, and manages API types. It includes methods for adding models, finding them by key, and converting API types to the defined enumeration. |
| [`src/poemai_utils/aws/dynamodb.py`](src/poemai_utils/aws/dynamodb.py)| This file defines a DynamoDB utility class for handling serialization and deserialization of data types between Python and DynamoDB. It includes custom exceptions, a BinaryPoemai class for binary data, and a TypeDeserializerPoemai class for converting DynamoDB types to Python types. The main class, DynamoDB, initializes a connection to DynamoDB and provides a method to store items. |
| [`src/poemai_utils/aws/dynamodb_emulator.py`](src/poemai_utils/aws/dynamodb_emulator.py)| The file defines a `DynamoDBEmulator` class that simulates a DynamoDB-like storage using SQLite. It provides methods for storing, retrieving, updating, and deleting items, along with handling versioning and composite keys. The class uses threading for concurrency control and supports batch operations and pagination. |
| [`src/poemai_utils/aws/lambda_utils.py`](src/poemai_utils/aws/lambda_utils.py)| This file contains utility functions for AWS Lambda, specifically for extracting parameters from events triggered by API Gateway or SQS, and for invoking Lambda functions with exponential backoff in case of throttling. It includes error handling and logging for better traceability. |
| [`src/poemai_utils/aws/local_lambda_runtime.py`](src/poemai_utils/aws/local_lambda_runtime.py)| This file implements a local AWS Lambda runtime using FastAPI, allowing the emulation of multiple Lambda functions in Docker. It sets up an application that forwards requests to the appropriate function based on environment variables, enabling local testing of Lambda functions with specified URLs. |
| [`src/poemai_utils/basic_types_utils.py`](src/poemai_utils/basic_types_utils.py)| This file contains utility functions for text formatting and data manipulation. Key functions include adding line breaks for readability, truncating text for short displays, removing None values from dictionaries, comparing values as strings, and converting various types to boolean. These functions enhance data handling and presentation in the project. |
| [`src/poemai_utils/collect_text_files.py`](src/poemai_utils/collect_text_files.py)| This file is a Python script that collects source code files from a specified directory and its subdirectories, writing their contents into a single output text file. It allows filtering by file extensions, defaulting to Python files. The main components include the `collect_source_files` function and a command-line interface for user input. |
| [`src/poemai_utils/dict_index.py`](src/poemai_utils/dict_index.py)| The file defines a class `DictIndex` that indexes a list of dictionaries by specified keys, allowing retrieval of objects based on key-value pairs. It includes methods for initialization and fetching indexed objects, with error handling for key presence and data types. |
| [`src/poemai_utils/embeddings/cross_similarity_analyzer.py`](src/poemai_utils/embeddings/cross_similarity_analyzer.py)| The CrossSimilarityAnalyzer class analyzes the similarity between two lists of embeddings using two SelfSimilarityAnalyzer instances. It provides methods to add text and embeddings, compute a cross similarity matrix, and find top similar pairs or map embeddings from one list to another with scores. |
| [`src/poemai_utils/embeddings/embedder_base.py`](src/poemai_utils/embeddings/embedder_base.py)| The file defines the `EmbedderBase` class, which serves as a base class for embedding models. It includes an initializer that allows the option to use cosine similarity and an abstract method `embedding_dim` that must be implemented by subclasses. This structure is intended for creating various embedding strategies in the project. |
| [`src/poemai_utils/embeddings/embedder_factory.py`](src/poemai_utils/embeddings/embedder_factory.py)| This file defines a deprecated function `make_embedder` that creates an embedding model based on a given model ID. It attempts to instantiate either a `SentenceTransformerEmbedder` or an `OpenAIEmbedder` depending on the model type, handling errors for unknown models or unsupported embedding types. |
| [`src/poemai_utils/embeddings/embedding_cache.py`](src/poemai_utils/embeddings/embedding_cache.py)| This file defines classes for caching embeddings using either in-memory storage or SQLite database. The `EmbeddingCache` class provides methods to store and retrieve embeddings based on text input and model name, while `EmbeddingCacheSqliteDict` and `EmbeddingCacheMemory` extend this functionality for persistent and temporary storage, respectively. |
| [`src/poemai_utils/embeddings/embedding_store.py`](src/poemai_utils/embeddings/embedding_store.py)| The file defines the `EmbeddingStore` class, which manages text and their corresponding embeddings using an embedder and an optional embedding cache. It provides methods to add texts, query embeddings, and calculate similarity scores between embeddings. The class ensures that the embedder and cache are of the correct types and handles embedding creation and storage efficiently. |
| [`src/poemai_utils/embeddings/openai_embedder.py`](src/poemai_utils/embeddings/openai_embedder.py)| This file defines the `OpenAIEmbedder` class, which is responsible for generating embeddings using OpenAI's API. It initializes with a specified model and API key, checks model compatibility, and provides methods to calculate embeddings and retrieve the embedding dimensions. |
| [`src/poemai_utils/embeddings/openai_embedder_lean.py`](src/poemai_utils/embeddings/openai_embedder_lean.py)| The file defines the `OpenAIEmbedderLean` class, a lightweight embedding generator that interacts with the OpenAI API using the `requests` library. It minimizes dependencies for environments like AWS Lambda, providing methods to calculate embeddings and retrieve their dimensions. The class includes error handling and logging for API interactions. |
| [`src/poemai_utils/embeddings/self_similarity_analyzer.py`](src/poemai_utils/embeddings/self_similarity_analyzer.py)| The SelfSimilarityAnalyzer class analyzes text embeddings for self-similarity. It allows adding text and embeddings, querying for similar texts, and calculating a similarity matrix. Key methods include adding text/embeddings, querying for top similar items, and finding the most similar pairs based on cosine similarity or other metrics. |
| [`src/poemai_utils/embeddings/sentence_transformer_embedder.py`](src/poemai_utils/embeddings/sentence_transformer_embedder.py)| This file defines the `SentenceTransformerEmbedder` class, which extends the `EmbedderBase` class. It initializes a sentence transformer model for generating text embeddings and provides methods to calculate embeddings and retrieve the embedding dimensions. The class requires the `sentence-transformers` library for functionality. |
| [`src/poemai_utils/embeddings/sentence_transformer_embedding_model.py`](src/poemai_utils/embeddings/sentence_transformer_embedding_model.py)| This file defines an enumeration for various sentence transformer embedding models used in AI applications. It includes model names and their associated attributes, such as cosine similarity usage and embedding dimensions. The class also registers these models with the AIModel class, enhancing their functionality within the project. |
| [`src/poemai_utils/embeddings/sgpt_embedder.py`](src/poemai_utils/embeddings/sgpt_embedder.py)| This file defines the `SGPTEmbedder` class, which is an implementation of an embedding model using the SGPT architecture. It includes methods for tokenizing input text with special tokens, calculating weighted mean embeddings, and retrieving the embedding dimension. The class utilizes the Hugging Face Transformers library for model and tokenizer management. |
| [`src/poemai_utils/enum_utils.py`](src/poemai_utils/enum_utils.py)| This file defines utility functions for enhancing Python Enum classes with custom string representations and attributes. It includes functions to format enum instances as strings, add attributes to enums, and ensure consistency across enum definitions. The main components are functions for string representation and attribute management for enums. |
| [`src/poemai_utils/excel_writer.py`](src/poemai_utils/excel_writer.py)| This file defines a function `write_excel` that creates an Excel file using the `openpyxl` library. It takes a filename and a list of lists as data, formats the data, and writes it to an Excel sheet while adjusting column widths based on content length. It also handles hyperlinks and NaN values appropriately. |
| [`src/poemai_utils/expiring_cache.py`](src/poemai_utils/expiring_cache.py)| The ExpiringCache class implements a cache system that stores key-value pairs with a maximum size and an expiration time. It allows adding new entries and retrieving them while ensuring that expired or least recently used items are removed. The class uses a dictionary for storage and a deque to track the order of keys. |
| [`src/poemai_utils/file_utils.py`](src/poemai_utils/file_utils.py)| This file provides utility functions to retrieve resource paths and strings from a specified sub-package within a Python package. It uses the `pkg_resources` module to locate resources based on the package structure, allowing for easy access to files bundled with the package. |
| [`src/poemai_utils/llama_cpp/ask_llama.py`](src/poemai_utils/llama_cpp/ask_llama.py)| This file defines the `AskLlama` class, which interfaces with the Llama model for generating text completions. It includes methods for synchronous and asynchronous prompts, token counting, and error handling. The class utilizes configuration settings and logging for better management and debugging. |
| [`src/poemai_utils/openai/ask.py`](src/poemai_utils/openai/ask.py)| This file defines the `Ask` class for interacting with OpenAI's API, specifically for chat and completion tasks. It manages API keys, logging, and token counting, and provides methods to send prompts and receive responses from the model. Key components include methods for handling chat messages and managing API interactions. |
| [`src/poemai_utils/openai/llm_answer_cache.py`](src/poemai_utils/openai/llm_answer_cache.py)| The LLMAnswerCache class manages caching for answers generated by a language model. It provides methods to fetch and store answers in a cache using a unique key derived from input parameters. The cache key is calculated using a SHA-256 hash of the prompt and other parameters, ensuring efficient retrieval and storage of model responses. |
| [`src/poemai_utils/openai/llm_answer_cache_dao.py`](src/poemai_utils/openai/llm_answer_cache_dao.py)| This file defines an abstract base class for a cache data access object (DAO) for storing and retrieving LLM answers. It includes two implementations: one using SQLite for persistent storage and another using an in-memory dictionary. The main components are the abstract class LLMAnswerCacheDao and its concrete implementations LLMAnswerCacheSqliteDict and LLMAnswerCacheDaoDict. |
| [`src/poemai_utils/openai/openai_model.py`](src/poemai_utils/openai/openai_model.py)| This file defines an enumeration for various OpenAI models, including their attributes such as model keys, API types, and whether they support vision. It includes methods for retrieving models by key and registering AI models. The file enhances the functionality of the AI model management within the project. |
| [`src/poemai_utils/operations_utils.py`](src/poemai_utils/operations_utils.py)| This file defines a decorator for logging the execution time of functions and a class for handling graceful shutdowns of a program. The `log_call_time` decorator logs the function name and its execution duration, while the `GracefulStopper` class manages termination signals to allow for a clean exit. |
| [`src/poemai_utils/reranker.py`](src/poemai_utils/reranker.py)| This file contains functions for ranking items based on user-defined ranking functions. It includes methods to calculate ranks, rerank items with weighted scores, and normalize scores before ranking. The main components are `calc_rank`, `rerank`, `rerank_weighted_score`, and `rerank_weighted_score_normalized`, which facilitate flexible ranking strategies. |
| [`src/poemai_utils/simple.py`](src/poemai_utils/simple.py)| This file imports various components related to embeddings and OpenAI functionalities, including analyzers for cross and self-similarity, an embedding cache, and an OpenAI embedder. It also imports a model and an asking mechanism for OpenAI, indicating its role in handling and processing embeddings and interactions with OpenAI's services. |
| [`src/poemai_utils/simple_cache.py`](src/poemai_utils/simple_cache.py)| The file defines a `SimpleCache` class that implements a basic caching mechanism with a maximum size limit. It uses a dictionary to store cached items and a deque to maintain the order of keys. The class provides methods to add (`put`) and retrieve (`get`) cached data, ensuring that the least recently used items are removed when the cache exceeds its size limit. |
| [`src/poemai_utils/state_machine.py`](src/poemai_utils/state_machine.py)| This file defines a lightweight state machine class for managing event-driven code. It allows for structured state transitions based on defined events, improving code maintainability. Key components include attributes for initial state, transitions, error handling, and logging, along with a method to process events and update the current state accordingly. |
| [`src/poemai_utils/time_utils.py`](src/poemai_utils/time_utils.py)| This file defines a function, `current_time_iso`, which returns the current date and time in ISO 8601 format, using UTC timezone. It imports the `datetime` and `timezone` classes from the `datetime` module to achieve this functionality. |
| [`src/poemai_utils/tools/html_to_md_ai.py`](src/poemai_utils/tools/html_to_md_ai.py)| This file is a command-line utility that converts HTML files to Markdown format using the OpenAI model for text processing. It reads an HTML file, extracts text, splits it into manageable chunks, and processes each chunk to format it into Markdown, while logging the progress and saving the output to a specified file. |
| [`src/poemai_utils/utils_config.py`](src/poemai_utils/utils_config.py)| This file defines a function `get_config_by_key` that retrieves configuration values from environment variables or a default configuration dictionary. It checks if a specified key exists in the environment and returns its value; otherwise, it returns `None` or the default value if available. |
| [`src/poemai_utils/web_utils.py`](src/poemai_utils/web_utils.py)| This file defines a function `ensure_encoded` that takes a URL as input, decodes it if necessary, and then re-encodes it to ensure it is properly formatted. The function handles cases where the URL may already be encoded, ensuring that it is quoted exactly once before returning the result. |
| [`tests/integration/create_test_table.sh`](tests/integration/create_test_table.sh)| This Bash script creates a DynamoDB table named 'poemai-integration-test' with specified attribute definitions and key schema. It uses AWS CLI commands to set up the table with a pay-per-request billing mode, making it suitable for integration testing within the project. |
| [`tests/integration/test_dynamodb.py`](tests/integration/test_dynamodb.py)| This file contains integration tests for the DynamoDB functionality in the poemai-utils project. It includes setup and teardown functions to manage test data, and various test cases to verify storing, loading, deleting, and scanning items in a DynamoDB table. The tests utilize pytest for structure and assertions. |
| [`tests/unit/test_ai_model.py`](tests/unit/test_ai_model.py)| This file contains unit tests for the AIModel class, specifically focusing on the retrieval and management of AI models defined in the OPENAI_MODEL enum. It includes tests for adding models, accessing them by various keys, and checking their properties, ensuring the functionality of the AIModel class is robust and reliable. |
| [`tests/unit/test_ask.py`](tests/unit/test_ask.py)| This file contains unit tests for the `Ask` class from the `poemai_utils.openai` module. It tests the token counting functionality and the asynchronous request handling using mocked HTTP clients. The tests ensure that the `Ask` class correctly processes responses from an OpenAI-like API and verifies the expected behavior of the async methods. |
| [`tests/unit/test_dict_index.py`](tests/unit/test_dict_index.py)| This file contains unit tests for the `DictIndex` class from the `poemai_utils.dict_index` module. It tests the functionality of indexing objects by specified keys, handling cases where not all objects have the required keys, and ensuring proper error handling for invalid key queries. |
| [`tests/unit/test_dynamodb_emulator.py`](tests/unit/test_dynamodb_emulator.py)| This file contains a test suite for the DynamoDBEmulator, verifying its functionality by storing, retrieving, updating, and deleting items in a simulated DynamoDB environment. It checks for version control during updates and ensures no duplicate entries are stored, while also validating the sorting of items by composite keys. |
| [`tests/unit/test_embedder_lean.py`](tests/unit/test_embedder_lean.py)| This file contains a unit test for the OpenAIEmbedderLean class from the poemai_utils.embeddings.openai_embedder_lean module. It uses unittest.mock to simulate API requests and validate the embedding calculation for a given text input, ensuring the output matches the expected embedding array. |
| [`tests/unit/test_embedding.py`](tests/unit/test_embedding.py)| This file contains unit tests for various embedding functionalities in the poemai-utils project. It includes tests for a mock embedder, an embedding factory function, and the SGPT embedder, ensuring that the correct types of embedder instances are created and that the embedding dimensions are as expected. |
| [`tests/unit/test_expiring_cache.py`](tests/unit/test_expiring_cache.py)| This file contains unit tests for the ExpiringCache class from the poemai_utils module. It tests the cache's behavior when the maximum number of items is exceeded and checks the timeout functionality to ensure that expired items are removed correctly. The tests validate both item retrieval and expiration logic. |
| [`tests/unit/test_lambda_utils.py`](tests/unit/test_lambda_utils.py)| This file contains unit tests for AWS Lambda utility functions, specifically for extracting parameters from various event types and invoking Lambda functions with a backoff strategy. It tests different scenarios including API Gateway requests, SQS messages, and direct invocations, ensuring the correct parameters are extracted and the backoff mechanism works as intended. |
| [`tests/unit/test_reranker.py`](tests/unit/test_reranker.py)| This file contains unit tests for the functions `calc_rank` and `rerank` from the `poemai_utils.reranker` module. It tests the ranking of items based on different criteria, ensuring that the functions return the expected results and handle errors appropriately when invalid ranking functions are provided. |
| [`tests/unit/test_state_machine.py`](tests/unit/test_state_machine.py)| This file contains unit tests for the StateMachine class from the poemai_utils module. It tests state transitions, implicit self-transitions, and error handling within the state machine. Each test checks the current state after processing specific events, ensuring the state machine behaves as expected under various conditions. |
